import { useEffect, useRef } from 'react';
import mapboxgl from 'mapbox-gl';
import 'mapbox-gl/dist/mapbox-gl.css';

const Map = () => {
  const mapContainer = useRef<HTMLDivElement>(null);
  const map = useRef<mapboxgl.Map | null>(null);

  useEffect(() => {
    if (!mapContainer.current || map.current) return;

    mapboxgl.accessToken = 'pk.eyJ1IjoicmFmYXJhaWhhbnIiLCJhIjoiY21obGNvcnYxMXo4NzJrcHE0Nm53NTZwdCJ9.mNxyT4v9xqJUu-Gwk1nF6A';
    
    map.current = new mapboxgl.Map({
      container: mapContainer.current,
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [106.8282, -6.3650], // Center between routes
      zoom: 13,
      pitch: 45,
    });

    map.current.addControl(
      new mapboxgl.NavigationControl({
        visualizePitch: true,
      }),
      'top-right'
    );

    map.current.on('style.load', () => {
      if (!map.current) return;
      
      map.current.setFog({
        color: 'hsl(var(--background))',
        'high-color': 'hsl(var(--muted))',
        'horizon-blend': 0.1,
      });

      // Define routes data
      const ruteBipolPagi = [
        [106.82442672767823, -6.371652849002165],
        [106.82406284331717, -6.371666869491176],
        [106.82400869439084, -6.371629588149347],
        [106.82397919037493, -6.3713856816309535],
        [106.82396309736485, -6.371125781310585],
        [106.82394968631164, -6.370600649527726],
        [106.82392822882588, -6.370250116860132],
        [106.82419510857854, -6.370231457453673],
        [106.82403417601651, -6.366948701129196],
        [106.82307662740313, -6.366927375783644],
        [106.82295190468999, -6.366928708593834],
        [106.82265038025012, -6.366877515581393],
        [106.82238625718091, -6.366740391778335],
        [106.8217141232146, -6.366135087934355],
        [106.8215308140501, -6.365903935986858],
        [106.82145197141364, -6.365745263799935],
        [106.8214421159044, -6.365717839207456],
        [106.8214322606977, -6.365443591093928],
        [106.82152292950728, -6.365228110451426],
        [106.82258074355968, -6.361813630190757],
        [106.82267765903862, -6.36156628675808],
        [106.82300577227879, -6.360561618247093],
        [106.82646484915253, -6.349295297042475],
        [106.82662961097681, -6.348881237733786],
        [106.82679056241071, -6.348645861184371],
        [106.82699060247094, -6.348504178797341],
        [106.82762980989762, -6.3481842494709815],
        [106.82781145521375, -6.348127118997285],
        [106.82814715428164, -6.348124834250687],
        [106.83132063747823, -6.348686589888224],
        [106.83161265009271, -6.348812276115519],
        [106.83179664735408, -6.348996564738525],
        [106.83189526988951, -6.3491492477541085],
        [106.83194268527521, -6.349399949471629],
        [106.83191423626853, -6.349586562107233],
        [106.83154951832383, -6.351188705704311],
        [106.83154951797322, -6.351352158746319],
        [106.83169725593977, -6.351778800340975],
        [106.8318143315671, -6.352011514222904],
        [106.83192304430808, -6.3524132211112905],
        [106.83190074442314, -6.353014397092337],
        [106.83166659344568, -6.354139174955968],
        [106.8315857556035, -6.354333102237226],
        [106.83034809932248, -6.355903909292467],
        [106.83026168792674, -6.356067360251776],
        [106.83020315015507, -6.356229155723879],
        [106.83019177056302, -6.35654017224898],
        [106.830222116269, -6.356738091801801],
        [106.83027522131749, -6.356883232821711],
        [106.83039281115632, -6.357058533052631],
        [106.83116913303435, -6.358062508867046],
        [106.83121275452656, -6.358205763954129],
        [106.83183145727551, -6.362196287857281],
        [106.83188835612688, -6.362686369678626],
        [106.83196611676709, -6.363206608337798],
        [106.83214819087186, -6.364137759619623],
        [106.83218612295519, -6.364463850705876],
        [106.83219370944018, -6.364786171822743],
        [106.83213870806277, -6.367655009436075],
        [106.83210077593748, -6.3678076870555405],
        [106.83121505931135, -6.368703017072651],
        [106.83109936601988, -6.368848154853232],
        [106.83104626118912, -6.369117695630399],
        [106.83100074261294, -6.36989615967564],
        [106.83097987993587, -6.370508751524728],
        [106.8309191884381, -6.370763212744939],
        [106.83077125307008, -6.371013903735322],
        [106.8305588327837, -6.371238206455704],
        [106.82989312322047, -6.371645343487923],
        [106.82972242824667, -6.3716736168969215],
        [106.82857118742204, -6.37164157346438],
        [106.82777650791444, -6.371628379021292],
        [106.82754701861623, -6.371581257070012],
        [106.82722649165235, -6.371360724174208],
        [106.82532988352169, -6.3693231498366885],
        [106.82509849740109, -6.369027220068561],
        [106.82502263320343, -6.368752024143348],
        [106.8249922870877, -6.3685428002266695],
        [106.82497901093811, -6.367234674795403],
        [106.82495625163756, -6.367144199176982],
        [106.82480641967074, -6.367000946073418],
        [106.82462434540332, -6.366929319410343],
        [106.82419950519345, -6.366934973541951],
        [106.8242222638335, -6.367734175163849],
        [106.8242222638335, -6.370610536458855],
        [106.82441571783855, -6.370678392243527],
        [106.82441761492113, -6.371102493717312],
        [106.82441002835097, -6.371366379045477],
        [106.82443089088757, -6.371654768165203]
      ];

      const ruteBipolSore = [
        [106.831697, -6.351814],
        [106.831863, -6.352137],
        [106.831920, -6.352489],
        [106.831879, -6.352952],
        [106.831673, -6.354154],
        [106.830275, -6.355982],
        [106.830157, -6.356449],
        [106.830284, -6.356934],
        [106.831209, -6.358163],
        [106.831871, -6.362697],
        [106.831955, -6.363241],
        [106.832169, -6.364361],
        [106.832180, -6.364643],
        [106.832126, -6.367669],
        [106.832097, -6.367791],
        [106.832024, -6.367906],
        [106.831142, -6.368770],
        [106.831072, -6.368884],
        [106.830954, -6.370622],
        [106.830900, -6.370801],
        [106.830509, -6.371273],
        [106.829755, -6.371675],
        [106.827644, -6.371609],
        [106.827234, -6.371366],
        [106.825107, -6.369023],
        [106.825008, -6.368711],
        [106.824992, -6.367202],
        [106.824868, -6.367021],
        [106.824643, -6.366925],
        [106.824187, -6.366933],
        [106.824361, -6.370596],
        [106.824404, -6.370686],
        [106.824423, -6.371635],
        [106.824062, -6.371653],
        [106.824007, -6.371604],
        [106.823978, -6.371159],
        [106.823978, -6.371159],
        [106.823942, -6.370263],
        [106.824207, -6.370237],
        [106.824042, -6.366937],
        [106.822922, -6.366918],
        [106.822439, -6.366770],
        [106.821538, -6.365893],
        [106.821445, -6.365460],
        [106.821978, -6.363840],
        [106.822061, -6.363858],
        [106.821599, -6.365354],
        [106.821573, -6.365646],
        [106.821670, -6.365879],
        [106.822449, -6.366674],
        [106.822984, -6.366843],
        [106.824922, -6.366860],
        [106.825128, -6.367109],
        [106.825088, -6.368654],
        [106.825182, -6.368965],
        [106.827334, -6.371310],
        [106.827731, -6.371536],
        [106.829861, -6.371583],
        [106.830465, -6.371206],
        [106.830775, -6.370821],
        [106.830884, -6.370522],
        [106.830933, -6.369008],
        [106.831022, -6.368784],
        [106.831985, -6.367819],
        [106.832055, -6.367664],
        [106.832105, -6.364487],
        [106.831961, -6.363674],
        [106.831781, -6.363386],
        [106.831666, -6.363010],
        [106.831655, -6.362749],
        [106.831768, -6.362410],
        [106.831079, -6.358165],
        [106.831009, -6.357987],
        [106.830148, -6.356843],
        [106.830076, -6.356521],
        [106.830124, -6.356134],
        [106.830258, -6.355881],
        [106.831477, -6.354294],
        [106.831595, -6.354008],
        [106.831837, -6.352601],
        [106.831831, -6.352337],
        [106.831649, -6.351833],
        [106.831697, -6.351814]
      ];

      // Add morning route layer
      map.current.addSource('route-pagi', {
        type: 'geojson',
        data: {
          type: 'Feature',
          properties: {},
          geometry: {
            type: 'LineString',
            coordinates: ruteBipolPagi
          }
        }
      });

      map.current.addLayer({
        id: 'route-pagi-line',
        type: 'line',
        source: 'route-pagi',
        layout: {
          'line-join': 'round',
          'line-cap': 'round'
        },
        paint: {
          'line-color': '#BF1E2E',
          'line-width': 6
        }
      });

      // Add afternoon route layer
      map.current.addSource('route-sore', {
        type: 'geojson',
        data: {
          type: 'Feature',
          properties: {},
          geometry: {
            type: 'LineString',
            coordinates: ruteBipolSore
          }
        }
      });

      map.current.addLayer({
        id: 'route-sore-line',
        type: 'line',
        source: 'route-sore',
        layout: {
          'line-join': 'round',
          'line-cap': 'round'
        },
        paint: {
          'line-color': '#159BB3',
          'line-width': 6
        }
      });

      // Create bus icon SVG
      const createBusMarker = (color: string) => {
        const el = document.createElement('div');
        el.innerHTML = `
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="4" y="4" width="16" height="16" rx="2" fill="${color}" stroke="white" stroke-width="2"/>
            <rect x="7" y="8" width="4" height="4" fill="white" rx="1"/>
            <rect x="13" y="8" width="4" height="4" fill="white" rx="1"/>
            <rect x="8" y="16" width="8" height="2" fill="white" rx="1"/>
          </svg>
        `;
        el.style.cursor = 'pointer';
        return el;
      };

      // Add markers for route start points
      new mapboxgl.Marker({ element: createBusMarker('#BF1E2E') })
        .setLngLat(ruteBipolPagi[0] as [number, number])
        .setPopup(new mapboxgl.Popup().setHTML('<strong>Rute Pagi</strong><br/>Start: 06:00'))
        .addTo(map.current);

      new mapboxgl.Marker({ element: createBusMarker('#159BB3') })
        .setLngLat(ruteBipolSore[0] as [number, number])
        .setPopup(new mapboxgl.Popup().setHTML('<strong>Rute Sore</strong><br/>Start: 12:00'))
        .addTo(map.current);
    });

    return () => {
      map.current?.remove();
    };
  }, []);

  return (
    <div className="relative h-full w-full">
      <div ref={mapContainer} className="absolute inset-0" />
    </div>
  );
};

export default Map;
